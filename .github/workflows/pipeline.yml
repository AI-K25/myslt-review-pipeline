# name: Run MYSLT Reviews Pipeline

# on:
#   schedule:
#     - cron: "30 2 * * *"   # Every day at 8 AM 
#   workflow_dispatch:      # Allow manual trigger

# permissions:
#   contents: write

# jobs:
#   run-pipeline:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v3

#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: "3.10"

#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt

#       - name: Run MYSLT Reviews Pipeline
#         run: python myslt_reviews_pipeline.py

#       - name: Commit and Push Updated CSVs
#         run: |
#           git config --global user.name "github-actions[bot]"
#           git config --global user.email "github-actions[bot]@users.noreply.github.com"
#           git add feature_requests_only.csv categorized_feature_requests.csv feature_requests_summary.csv
#           git commit -m "Update feature request CSVs [skip ci]" || echo "No changes to commit"
#           git push

#       - name: Send Email with Feature Requests Summary
#         uses: dawidd6/action-send-mail@v3
#         with: 
#           server_address: smtp.gmail.com
#           server_port: 587
#           username: ${{ secrets.EMAIL_USERNAME }}
#           password: ${{ secrets.EMAIL_PASSWORD }}
#           subject: "Daily Feature Requests Summary - MYSLT App"
#           to: "kaveeshanirmani25@gmail.com "
#           from: "MYSLT Bot <${{ secrets.EMAIL_USERNAME }}>"
#           body: |
#             Hello Team,

#             Please find attached the latest feature requests summary extracted from app reviews.

#             You can also view the full interactive dashboard here:
#             ðŸ‘‰ http://124.43.216.136:8501/review/

#             Best,
#             MYSLT Bot
#           attachments: |
#             feature_requests_summary.csv
#             categorized_feature_requests.csv


name: Run MYSLT Reviews Pipeline

on:
  schedule:
    - cron: "30 2 * * *"   # Every day at 8:00 AM Sri Lanka time (UTC+5:30)
  workflow_dispatch:        # Allow manual trigger

permissions:
  contents: write

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run MYSLT Reviews Pipeline
        run: python myslt_reviews_pipeline.py

      - name: Commit and Push Updated CSVs
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add feature_requests_only.csv categorized_feature_requests.csv feature_requests_summary.csv || echo "No CSVs to add"
          git diff --quiet && echo "No changes to commit" || (git commit -m "Update feature request CSVs [skip ci]" && git push)

      - name: Check if 30 days have passed since last email
        id: check_email_time
        run: |
          if [ ! -f .last_email_sent ]; then
            echo "No email log found. Sending email..."
            echo "send_email=true" >> $GITHUB_ENV
          else
            LAST_SENT=$(cat .last_email_sent)
            NOW=$(date +%s)
            DIFF=$(( (NOW - LAST_SENT) / 86400 ))
            echo "Days since last email: $DIFF"
            if [ $DIFF -ge 30 ]; then
              echo "send_email=true" >> $GITHUB_ENV
            else
              echo "send_email=false" >> $GITHUB_ENV
            fi
          fi

      - name: Send Email with Feature Requests Summary
        if: env.send_email == 'true'
        uses: dawidd6/action-send-mail@v3
        with: 
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Monthly Feature Requests Summary - MYSLT App"
          to: "kaveeshanirmani25@gmail.com"
          from: "MYSLT Bot <${{ secrets.EMAIL_USERNAME }}>"
          body: |
            Hello Team,

            Please find attached the latest **monthly** feature requests summary extracted from app reviews.

            You can also view the full interactive dashboard here:
            ðŸ‘‰ http://124.43.216.136:8501/review/

            Best,
            MYSLT Bot
          attachments: |
            feature_requests_summary.csv
            categorized_feature_requests.csv

      - name: Update Email Timestamp
        if: env.send_email == 'true'
        run: |
          date +%s > .last_email_sent
          git add .last_email_sent
          git commit -m "Update last email timestamp [skip ci]" || echo "No timestamp changes"
          git push
